# EVM

## EVMとは

Ethereum Virtual Machineの略。Ethereumのバイトコードを実行するためのバーチャルマシン。  

32byteベース、つまりスタックの各層が32byteのスタックマシン。  
32byteベースなのでuint256といった一般的な高級言語では定義されていない整数型をよく利用する。

## ステートについて

#### World State

Ethereumネットワークで共有されるステート。

アドレス一覧やアカウントの状態(残高、ストレージ、コントラクトコード)などを含んでいる。

state.rsで実装しているのはこの部分

#### Machine State

現在のEVMのステート。

Gas残量、PC、メモリ、スタックなどトランザクションの実行に必要な一時情報を含んでいる。

このステートはstate.rsではなく、vm.rsでアクションの間、保持されるインスタンス変数に格納される。

## コントラクトへのデプロイ

コントラクトデプロイ時には通常の場合と同様にトランザクションを起こしてEVMバイトコードを実行させる必要があるが、このとき実行されるバイトコードはデプロイするEVMバイトコードとは異なったものが実行される

例えば、`6005600401`というEVMバイトコードをデプロイするとする。

これは逆アセンブルすると以下のようなコードである。

```
PUSH1  05   // 6005 
PUSH1  04   // 6004
ADD         // 01
```

このバイトコードをデプロイする際に実行されるバイトコードは以下のように`600580600b6000396000f36005600401`なる。

```
// デプロイ用のバイトコード
PUSH1  05   // 6005 
DUP1        // 80
PUSH1  0b   // 600b 
PUSH1  00   // 6000
CODECOPY    // 39 
PUSH1  00   // 6000 
RETURN      // f3 

// 本体のコード
PUSH1  05   // 6005 
PUSH1  04   // 6004
ADD         // 01
```

このデプロイ用のコードでは、最初にデプロイされるバイトコードの長さをスタックにpushしている(PUSH1 05)

そしてCODECOPYで0b-0b+05つまりデプロイされるバイトコードをメモリの先頭にコピーし、それをreturnで返しているため、デプロイを行うコード(`600580600b6000396000f36005600401`)の返り値はデプロイされるコード(`6005600401`)となる。

